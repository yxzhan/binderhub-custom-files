<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <title>{% block title %}IAI Binder{% endblock %}</title>
  <meta name="robots" content="noindex, nofollow">
  {% block meta_social %}
  {# Social media previews #}
  <meta property="og:title" content="The Binder Project">
  <meta property="og:image" content="https://mybinder.org/static/images/logo_social.png">
  <meta property="og:description" content="Reproducible, sharable, open, interactive computing environments.">
  <meta property="og:image:width" content="1334">
  <meta property="og:image:height" content="700">
  <meta property="og:image:alt" content="The Binder Project Logo" />
  <meta name="twitter:card" content="summary_large_image">
  {% endblock meta_social %}
  {% block head %}
  <link id="favicon" rel="shortcut icon" type="image/png" href="{{static_url("favicon.ico")}}" />
  <link href="{{static_url("dist/styles.css")}}" rel="stylesheet">
  </link>
  <style>
    #builtRepos {
      max-height: 650px;
      overflow: auto;
      padding: 2rem;
    }

    #builtRepos .jumbotron {
      padding: 1rem 3rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    #builtRepos .jumbotron .btn {
      width: 130px;
    }

    #builtRepos .jumbotron  {
      max-width: calc(100% - 130px);
    }
    
    #loader-text p.alert {
      font-size: 1.4em;
    }
    .url-row pre {
      white-space: break-spaces;
    }
    img.icon.clipboard {
      cursor: pointer;
      max-height: none;
    }
  </style>
  <script>
    const BUILTLISTAPI = {
      'http:': 'http://192.168.102.13:9091/built-repo',
      'https:': 'https://test.intel4coro.de/built-repo'
    }[location.protocol]

    function _renderBuiltRepos(data) {
      const containerDiv = document.getElementById("builtRepos")
      if (!containerDiv || !data) return
      if (data && data.length === 0) {
        containerDiv.innerHTML = '<div class="text-center">No built repos yet</div>';
        return false;
      }
      containerDiv.innerHTML += data.map(v => {
        return `
        <div class="jumbotron">
          <a target="_blank" href="${v.repo_url}">
            <h4>${v.repo_author}/${v.repo_name}/${v.repo_ref}</h4>
          </a>
          <a class="btn btn-submit" target="_blank" href="/v2${v.binder}">Launch</a>
        </div>
        `
      }).join('');
      return false;
    }

    function _postNewBuiltRepos(url) {
      const urlObj = new URL(url);
      const params = urlObj.searchParams;
      let providerSpec = urlObj.pathname.split('/');
      providerSpec.splice(0, 2);
      providerSpec = providerSpec.join('/');
      let pathType, path;
      path = params.get("urlpath");
      if (path) {
        pathType = "url";
      } else {
        path = params.get("labpath");
        if (path) {
          pathType = "lab";
        } else {
          path = params.get("filepath");
          if (path) {
            pathType = "file";
          }
        }
      }
      return _requestFunc(BUILTLISTAPI, 'POST', {
        providerSpec: providerSpec,
        path: encodeURIComponent(path || ''),
        pathType: pathType || '',
      });
    }

    function _requestFunc(url = '', method = 'GET', data) {
      const params = {
        method: method, // *GET, POST, PUT, DELETE, etc.
        headers: {
          'Content-Type': 'application/json'
        }
      }
      if (method !== 'GET' && data) {
        params.body = JSON.stringify(data);
      }
      const requestPromise = fetch(url, params);
      return requestPromise.then(response => {
        return response.json();
      }).catch((error) => {
        console.log(error)
      });
    }

    async function showDockerHint() {
      // Get Repo info from URL
      const urlObj = new URL(location.href)
      let providerSpec = urlObj.pathname.split('/')
      providerSpec.splice(0, 2)
      let dockerTag = ''
      const commitInfo = await _requestFunc(`https://api.github.com/repos/${providerSpec[1]}/${providerSpec[2]}/commits/${providerSpec[3]}`)
      // const commitInfo = {
      //   sha: "0f5b3f06400f39b30cd1b20c9d84070dda11bdc2"
      // }
      const imagesAll = await _requestFunc('https://test.intel4coro.de/image')
      for (let repo in imagesAll) {
        if (imagesAll[repo].includes(commitInfo.sha)){
          dockerTag = `intel4coro/${repo}:${commitInfo.sha}`
          let newEle= document.createElement('p');
          newEle.classList.add('alert', 'alert-info');
          newEle.innerHTML =`
            If the server is unavailable, you can also run this program via 
            <a href="https://www.docker.com/" target="_blank">Docker</a> on your PC:
            <div class="url-row">
              <pre id="docker-command">docker run ${dockerTag}</pre>
              <img class="icon clipboard" src="{{static_url("images/copy-icon-black.svg")}}"
                data-clipboard-target="#docker-command" alt="Copy to clipboard">
            </div>
          `
          document.querySelector('#loader-text').appendChild(newEle)
          break
        }
      }
    }
    // Observer loader class "error" to see if it fail to start instance,
    // and display nicer error messages.
    document.addEventListener("DOMContentLoaded", () => {

      function beautifyErrors() {
        // Hide link text
        document.querySelector('#loader-links').style.display = 'none'

        // Panel displaying Error mesage
        const messagePanel = document.querySelector('#loader-text')

        // Create a new element for response
        let newEle= document.createElement('p');
        newEle.classList.add('alert', 'alert-warning');

        // Get raw message
        let rawErrorMsg = document.querySelector('.xterm-rows').textContent
        let explain = _requestFunc('https://test.intel4coro.de/error', 'POST', {
          data: rawErrorMsg
        }).then(res => {
          if (res['data'].length > 0) {
            newEle.innerHTML = res['data']
            messagePanel.appendChild(newEle)
            // Show hint of local running
            showDockerHint()
          }
        }).catch(_ => {
          newEle.innerHTML =`
              Our servers are currently experiencing a bit of a traffic jam due to high demand.
              Please try refreshing the page in a few minutes. 
              We're working on increasing capacity to provide a better experience.
            `
          messagePanel.appendChild(newEle)
          showDockerHint()
        })
      }

      // Create a MutationObserver instance
      const loaderStatObserver = new MutationObserver((mutationsList) => {
        // Iterate through the mutations that occurred
        for (const mutation of mutationsList) {
          // Check if the class attribute was modified
          if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
            if (mutation.target.className.includes('error')) {
              setTimeout(() => {
                beautifyErrors();
              }, 1000);
              break;
            }
          }
        }
      });

      // Start observing the target element
      const targetElement = document.getElementById('loader');
      !!targetElement && loaderStatObserver.observe(targetElement, {
        attributes: true,  // Observe changes to attributes
        attributeFilter: ['class']  // Specifically watch the 'class' attribute
      });
    })

  </script>
  <script>
    let test_windows = [];

    function startStress(url = '/', num = 1) {
      for (let i = 0; i < num; i++) {
        setTimeout(() => {
          // Generate random positions for the window
          let randomX = Math.floor(Math.random() * window.screen.width);
          let randomY = Math.floor(Math.random() * window.screen.height);

          // Set window size (you can adjust width and height as needed)
          let width = 400;
          let height = 300;

          // Open the window with random position and size

          let newWindow = window.open(
            url,
            '_blank',
            `width=${width},height=${height},left=${randomX},top=${randomY}`
          );

          test_windows.push(newWindow); // Store the reference to each window
        }, i * 1000);
      }
    }

    function stopStress() {
      for (let i = 0; i < test_windows.length; i++) {
        if (test_windows[i] && !test_windows[i].closed) {
          test_windows[i].close(); // Close each window
        }
      }
      test_windows = []; // Clear the references after closing
    }
  </script>
  </script>
  {% endblock head %}
</head>

<body>
  {% block body %}

  {% if banner %}
  <div id="banner-container">
    {{ banner | safe }}
  </div>
  {% endif %}

  {% block logo %}
  <div class="container">
    <div class="row">
      <div id="logo-container">
        <a href="/"><img id="logo" src="{{static_url("logo.svg")}}" width="330px" alt="logo" /></a>
        <a href="https://ai.uni-bremen.de/" target="_blank"><img id="logo-iai"
            src="https://intel4coro.ai.uni-bremen.de/assets/img/clients/iai.png" width="180px" alt="iai logo" /></a>
      </div>
    </div>
  </div>
  {% endblock logo %}

  {% block main %}
  {% endblock main %}

  {% block footer %}
  <div class="container">
    <div class="row text-center">
      <h3>questions?<br />join the <a href="https://discourse.jupyter.org/c/binder">discussion</a>, read the <a
          href="https://mybinder.readthedocs.io/en/latest/">docs</a>, see the <a
          href="https://github.com/jupyterhub/binderhub">code</a></h3>
    </div>
  </div>
  {% endblock footer %}

  {% if extra_footer_scripts %}
  {% for script in extra_footer_scripts|dictsort %}
  <script>
    { { script[1] | safe } }
  </script>
  {% endfor %}
  {% endif %}
  {% endblock body %}
</body>

</html>